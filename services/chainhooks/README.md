# Chainhooks Service

The Chainhooks service monitors the Stacks payment-router smart contract using [Hiro Chainhooks](https://www.npmjs.com/package/@hirosystems/chainhook-client) to track users and fees generated by smart contract events.

## Overview

This service:
- Monitors payment-router contract events on the Stacks blockchain
- Tracks user metrics (payments, volume, fees per agent)
- Tracks fee metrics (settlement fees, gas costs, fee basis points)
- Provides a REST API for querying metrics
- Persists metrics to a database for historical analysis

## Features

- **Real-time Event Monitoring**: Listens for contract events via Hiro Chainhooks
- **User Metrics Tracking**: Tracks payment activity per agent address
- **Fee Analytics**: Monitors settlement fees and calculates fee basis points
- **Protocol Metrics**: Aggregates protocol-wide statistics
- **REST API**: HTTP endpoints for querying metrics with filtering and pagination
- **Database Persistence**: Stores metrics for historical analysis

## Architecture

```
┌─────────────────┐
│ Chainhook Node  │ (Hiro Platform)
└────────┬────────┘
         │ HTTP POST
         ▼
┌─────────────────┐
│ Chainhooks      │
│ Service         │
│                 │
│ ┌─────────────┐ │
│ │ Observer    │ │
│ └──────┬──────┘ │
│        │        │
│ ┌──────▼──────┐ │
│ │ Metrics     │ │
│ │ Tracker     │ │
│ └──────┬──────┘ │
│        │        │
│ ┌──────▼──────┐ │
│ │ Database   │ │
│ └────────────┘ │
└────────┬───────┘
         │
         ▼
┌─────────────────┐
│ Metrics API     │ (HTTP Server)
└─────────────────┘
```

## Installation

```bash
cd services/chainhooks
npm install
```

## Configuration

Create a `.env` file in the `services/chainhooks` directory:

```env
# Chainhook Server Settings (where this service receives events)
CHAINHOOK_SERVER_HOSTNAME=0.0.0.0
CHAINHOOK_SERVER_PORT=3100
CHAINHOOK_SERVER_AUTH_TOKEN=your-secret-token-here
CHAINHOOK_EXTERNAL_BASE_URL=http://localhost:3100

# Chainhook Node Settings (Hiro Platform chainhook node)
CHAINHOOK_NODE_URL=http://localhost:20456

# Contract Settings
PAYMENT_ROUTER_CONTRACT=ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.payment-router-v2
STACKS_NETWORK=devnet
CHAINHOOK_START_BLOCK=100000

# Metrics API Settings
METRICS_API_HOSTNAME=0.0.0.0
METRICS_API_PORT=3101
```

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `CHAINHOOK_SERVER_HOSTNAME` | Hostname for the chainhook event server | `0.0.0.0` |
| `CHAINHOOK_SERVER_PORT` | Port for the chainhook event server | `3100` |
| `CHAINHOOK_SERVER_AUTH_TOKEN` | Authentication token for chainhook events | Required |
| `CHAINHOOK_EXTERNAL_BASE_URL` | Public URL where chainhook node can reach this service | Required |
| `CHAINHOOK_NODE_URL` | URL of the Hiro Platform chainhook node | `http://localhost:20456` |
| `PAYMENT_ROUTER_CONTRACT` | Stacks contract identifier | Required |
| `STACKS_NETWORK` | Network: `mainnet`, `testnet`, or `devnet` | `devnet` |
| `CHAINHOOK_START_BLOCK` | Block height to start monitoring from | Optional |
| `METRICS_API_HOSTNAME` | Hostname for the metrics API server | `0.0.0.0` |
| `METRICS_API_PORT` | Port for the metrics API server | `3101` |

## Usage

### Development

```bash
npm run dev
```

### Production

```bash
npm run build
npm start
```

The service will:
1. Initialize the chainhook observer
2. Register predicates for contract events
3. Start listening for events
4. Start the metrics API server

## API Endpoints

All endpoints are available at `http://localhost:3101` (or your configured port).

### Health Check

```http
GET /health
```

Returns service health status.

**Response:**
```json
{
  "status": "ok",
  "service": "chainhooks-metrics",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### Protocol Metrics

```http
GET /metrics/protocol
```

Returns protocol-wide aggregated metrics.

**Response:**
```json
{
  "totalUsers": 150,
  "totalPayments": 1250,
  "totalVolumeUSD": 50000.50,
  "totalFeesCollected": 250.25,
  "averageFeePerPayment": 0.20,
  "paymentsByChain": {
    "ethereum": 500,
    "arbitrum": 300,
    "base": 200,
    "polygon": 150,
    "stacks": 100
  },
  "volumeByChain": {
    "ethereum": 20000,
    "arbitrum": 15000,
    "base": 10000,
    "polygon": 3000,
    "stacks": 2000
  },
  "lastUpdated": "2024-01-01T00:00:00.000Z"
}
```

### User Metrics

#### Get All Users

```http
GET /metrics/users?sortBy=volume&sortOrder=desc&page=1&limit=20&minVolume=1000&minPayments=5
```

**Query Parameters:**
- `sortBy`: Sort field (`volume`, `payments`, `fees`, `lastPayment`)
- `sortOrder`: Sort direction (`asc`, `desc`)
- `page`: Page number (default: 1)
- `limit`: Items per page (default: 50)
- `minVolume`: Minimum total volume in USD
- `minPayments`: Minimum number of payments

**Response:**
```json
{
  "count": 150,
  "page": 1,
  "limit": 20,
  "totalPages": 8,
  "users": [
    {
      "agentAddress": "ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM",
      "totalPayments": 50,
      "totalVolumeUSD": 10000.00,
      "totalFeesGenerated": 50.00,
      "firstPaymentAt": "2024-01-01T00:00:00.000Z",
      "lastPaymentAt": "2024-01-15T00:00:00.000Z",
      "sourceChains": {
        "ethereum": 30,
        "arbitrum": 20
      },
      "updatedAt": "2024-01-15T00:00:00.000Z"
    }
  ]
}
```

#### Get Specific User

```http
GET /metrics/user/{agentAddress}
```

Returns metrics for a specific agent address.

### Fee Metrics

#### Get All Fees

```http
GET /metrics/fees?chain=ethereum&fromDate=2024-01-01&toDate=2024-01-31&minFee=1&page=1&limit=20
```

**Query Parameters:**
- `agent`: Filter by agent address
- `chain`: Filter by source chain
- `fromDate`: Start date (ISO 8601)
- `toDate`: End date (ISO 8601)
- `minFee`: Minimum fee in USD
- `page`: Page number (default: 1)
- `limit`: Items per page (default: 50)

**Response:**
```json
{
  "count": 1250,
  "page": 1,
  "limit": 20,
  "totalPages": 63,
  "fees": [
    {
      "intentId": "payment-intent-123",
      "agentAddress": "ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM",
      "settlementFee": 0.25,
      "settlementFeeBps": 25,
      "gasSpentUSD": 0.05,
      "totalFeesUSD": 0.30,
      "sourceChain": "ethereum",
      "sourceAmount": "1000000000000000000",
      "usdhAmount": "1000000",
      "timestamp": "2024-01-15T00:00:00.000Z"
    }
  ]
}
```

#### Get Specific Fee

```http
GET /metrics/fee/{intentId}
```

Returns fee metrics for a specific payment intent.

### Metrics Summary

```http
GET /metrics/summary?fromDate=2024-01-01&toDate=2024-01-31&topUsers=10&recentFees=10
```

**Query Parameters:**
- `fromDate`: Start date for filtering (ISO 8601)
- `toDate`: End date for filtering (ISO 8601)
- `topUsers`: Number of top users to return (default: 10)
- `recentFees`: Number of recent fees to return (default: 10)

**Response:**
```json
{
  "protocol": { /* ProtocolMetrics */ },
  "topUsers": [
    {
      "address": "ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM",
      "volume": 10000.00,
      "payments": 50,
      "fees": 50.00
    }
  ],
  "recentFees": [
    {
      "intentId": "payment-intent-123",
      "agent": "ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM",
      "fee": 0.30,
      "chain": "ethereum",
      "timestamp": "2024-01-15T00:00:00.000Z"
    }
  ],
  "summary": {
    "totalUsers": 150,
    "totalPayments": 1250,
    "totalVolume": 50000.50,
    "totalFees": 250.25,
    "averageFee": 0.20
  }
}
```

## Monitored Events

The service monitors the following payment-router contract events:

### payment-intent-created

Triggered when a new payment intent is created.

**Event Data:**
- `intentId`: Payment intent identifier
- `agent`: Agent address
- `sourceChain`: Source blockchain
- `expiresAt`: Expiration timestamp

### payment-detected

Triggered when a payment is detected on the source chain.

**Event Data:**
- `intentId`: Payment intent identifier
- `sourceTxHash`: Source transaction hash
- `detectedAt`: Detection timestamp

### payment-settled

Triggered when a payment is settled on Stacks.

**Event Data:**
- `intentId`: Payment intent identifier
- `agent`: Agent address
- `usdhAmount`: Amount in micro-USDh
- `netAmount`: Net amount after fees
- `feesPaid`: Fees paid in micro-USDh
- `sourceChain`: Source blockchain
- `settledAt`: Settlement timestamp

### payment-settled-with-withdraw

Triggered when a payment is settled with an instant withdrawal.

**Event Data:**
- Same as `payment-settled`
- `withdrawn`: Withdrawal amount

## Database Schema

Metrics are stored in a key-value database with the following keys:

- `protocol_metrics`: Protocol-wide aggregated metrics
- `user_metrics:{agentAddress}`: User-specific metrics
- `fee_metrics:{intentId}`: Fee metrics per payment intent

## Development

### Project Structure

```
services/chainhooks/
├── src/
│   ├── index.ts              # Service entry point
│   ├── ChainhooksService.ts   # Main service class
│   ├── MetricsTracker.ts      # Metrics tracking logic
│   └── api.ts                 # HTTP API server
├── package.json
├── tsconfig.json
└── README.md
```

### Adding New Metrics

1. Update the `ChainhookEvent` type in `shared/types/index.ts`
2. Add event handler in `MetricsTracker.ts`
3. Update database schema if needed
4. Add API endpoint in `api.ts` if needed

## Testing

Run tests:

```bash
npm test
```

## Troubleshooting

### Chainhook events not received

1. Verify the chainhook node is running and accessible
2. Check that `CHAINHOOK_EXTERNAL_BASE_URL` is publicly accessible
3. Verify the contract address is correct
4. Check that predicates are registered correctly

### Metrics not updating

1. Check service logs for errors
2. Verify database connection
3. Ensure events are being processed correctly

### API not responding

1. Check that the API server is running on the correct port
2. Verify CORS settings if accessing from a browser
3. Check service logs for errors

## License

MIT


